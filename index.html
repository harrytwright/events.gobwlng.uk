<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tournament Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  </head>
  <body class="bg-gray-50">
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Dynamic event header -->
      <header id="eventHeader" class="mb-6 text-center">
        <h1 class="text-3xl font-bold text-gray-900">Loading event…</h1>
        <p class="mt-1 text-gray-500">Please wait while we fetch the results.</p>
      </header>

      <section class="bg-white shadow rounded-lg">
        <div class="px-4 sm:px-6 pt-6">
          <div class="border-b border-gray-200">
            <nav
              id="tabsNav"
              class="-mb-px flex gap-4"
              role="tablist"
              aria-label="Results tabs"
            >
              <!-- Tabs will be injected from meta.json -->
            </nav>
          </div>

          <div class="mt-4">
            <div class="relative max-w-md">
              <input
                id="searchInput"
                type="text"
                placeholder="Search for a player or team..."
                class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
              <button
                id="clearSearchBtn"
                type="button"
                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-700"
                style="display: none"
                aria-label="Clear search"
              >
                <!-- Heroicon - X Mark (Mini) -->
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div id="panelsContainer" class="px-4 sm:px-6 pb-6">
          <!-- Tab panels will be injected from meta.json -->
        </div>
      </section>
    </main>

    <script>
      // ---- Utility: safe innerHTML for trusted SVG strings ----
      // Minimal helper to mirror the previous setHTMLUnsafe usage
      if (!Element.prototype.setHTMLUnsafe) {
        Element.prototype.setHTMLUnsafe = function (html) {
          this.innerHTML = html;
        };
      }

      // ---- Event configuration ----
      // Base path for this event; when you add more events,
      // this can be parameterised (e.g. via query string or build step).
      const EVENT_BASE_PATH = "./data/events/new-years-doubles/2026";

      // Preset widths per column key
      const columnWidthMap = {
        Place: "w-14 min-w-[3.5rem]",
        Squad: "w-12 min-w-[3rem]",
        Team: "w-28 min-w-[6rem]",
        Player: "w-32 min-w-[8rem]",
        "Player 1": "w-32 min-w-[8rem]",
        "Player 2": "w-32 min-w-[8rem]",
        HCP: "w-14 min-w-[3.5rem]",
        Scratch: "w-20 min-w-[5rem]",
        "Scratch Series": "w-24",
        "HCP Series": "w-24",
        "Game 1": "w-16",
        "Game 2": "w-16",
        "Game 3": "w-16",
        Pace: "w-14",
        Average: "w-20 min-w-[5rem]",
        // fallback default for unknown columns:
        "*": "min-w-[7rem]",
      };

      // Table state with headers, original rows, and last sort state
      // This is now dynamic; keys are slugified tab ids (from meta.files[].name)
      const tableState = {};

      const numericHeaderHints = [
        "place",
        "game",
        "series",
        "hcp",
        "average",
        "pace",
        "scratch",
      ];

      function normalizeRows(rows) {
        return rows.map((row) => {
          const out = {};
          Object.keys(row).forEach((k) => {
            const key = (k || "").trim();
            out[key] = row[k];
          });
          return out;
        });
      }

      function isLikelyNumericHeader(h) {
        return numericHeaderHints.some((k) => h.toLowerCase().includes(k));
      }

      function parseMaybeNumber(v) {
        if (typeof v === "number") return v;
        if (typeof v !== "string") return NaN;
        const s = v.replace(/,/g, "").trim();
        if (s === "") return NaN;
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
      }

      function sortRows(rows, key, dir) {
        const withIndex = rows.map((r, i) => ({ r, i }));
        const numericPreferred = isLikelyNumericHeader(key);
        withIndex.sort((a, b) => {
          const av = a.r[key] ?? a.r[key?.trim?.()];
          const bv = b.r[key] ?? b.r[key?.trim?.()];
          if (numericPreferred) {
            const an = parseMaybeNumber(av);
            const bn = parseMaybeNumber(bv);
            if (!Number.isNaN(an) && !Number.isNaN(bn)) {
              return dir === "asc" ? an - bn : bn - an;
            }
          }
          // Fallback string compare
          const as = (av ?? "").toString().toLowerCase();
          const bs = (bv ?? "").toString().toLowerCase();
          if (as < bs) return dir === "asc" ? -1 : 1;
          if (as > bs) return dir === "asc" ? 1 : -1;
          // stable
          return a.i - b.i;
        });
        return withIndex.map((x) => x.r);
      }

      function getColumnWidthClass(h) {
        return columnWidthMap[h] || columnWidthMap["*"];
      }

      // ---- Rendering: event header from meta.json ----

      function formatDateRange(dates) {
        if (!Array.isArray(dates) || dates.length === 0) return "";
        // Expecting dd/mm/yyyy or similar; we keep it simple and just join.
        if (dates.length === 1) return dates[0];
        if (dates.length === 2) return dates[0] + " – " + dates[1];
        return dates.join(", ");
      }

      function renderEventHeader(meta) {
        const header = document.getElementById("eventHeader");
        header.innerHTML = "";

        const title = document.createElement("h1");
        title.className = "text-3xl font-bold text-gray-900";
        title.textContent = meta.name || "Tournament Results";

        const infoRow = document.createElement("div");
        infoRow.className = "mt-2 flex flex-wrap items-center justify-center gap-3";

        if (meta.type || meta.format || meta.pattern) {
          const badge = document.createElement("span");
          badge.className =
            "text-sm text-blue-700 font-medium bg-blue-50 border border-blue-100 rounded px-2 py-0.5";
          const parts = [];
          if (meta.type) parts.push(capitalize(meta.type));
          if (meta.format) parts.push(prettyFormat(meta.format));
          if (meta.pattern) parts.push(meta.pattern);
          badge.textContent = parts.join(" • ");
          infoRow.appendChild(badge);
        }

        if (meta.dates && meta.dates.length) {
          const dateSpan = document.createElement("span");
          dateSpan.className = "text-sm text-gray-500";
          dateSpan.textContent = formatDateRange(meta.dates);
          infoRow.appendChild(dateSpan);
        }

        header.appendChild(title);
        if (infoRow.children.length) header.appendChild(infoRow);
      }

      function capitalize(str) {
        if (!str) return "";
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      function prettyFormat(str) {
        // e.g. "doubles-reentry" → "Doubles Reentry"
        return str
          .split(/[-_]/g)
          .map((part) => capitalize(part))
          .join(" ");
      }

      // ---- Tabs & panels from meta.json ----

      function slugify(str) {
        return (str || "")
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^[-]+|[-]+$/g, "");
      }

      function createTabAndPanel(id, label, isActive) {
        const tabsNav = document.getElementById("tabsNav");
        const panelsContainer = document.getElementById("panelsContainer");

        // Tab button
        const btn = document.createElement("button");
        btn.className =
          "tab-btn whitespace-nowrap border-b-2 px-3 py-2 text-sm font-medium " +
          (isActive
            ? "text-blue-600 border-blue-600"
            : "text-gray-500 hover:text-gray-700 border-transparent");
        btn.setAttribute("data-tab-target", id);
        btn.setAttribute("aria-selected", isActive ? "true" : "false");
        btn.setAttribute("role", "tab");
        btn.textContent = label;
        tabsNav.appendChild(btn);

        // Panel
        const panel = document.createElement("div");
        panel.id = id;
        panel.className =
          "tab-panel mt-6" + (isActive ? "" : " hidden");
        panel.setAttribute("role", "tabpanel");
        panel.setAttribute("aria-labelledby", id + "-tab");

        const wrapper = document.createElement("div");
        wrapper.className = "overflow-x-auto";

        const table = document.createElement("table");
        table.className = "min-w-full divide-y divide-gray-200";

        const thead = document.createElement("thead");
        thead.className = "bg-gray-50 sticky top-0 z-10";
        const trHead = document.createElement("tr");
        trHead.id = id + "Header";
        thead.appendChild(trHead);

        const tbody = document.createElement("tbody");
        tbody.id = id + "Body";
        tbody.className = "divide-y divide-gray-100";

        table.appendChild(thead);
        table.appendChild(tbody);
        wrapper.appendChild(table);
        panel.appendChild(wrapper);
        panelsContainer.appendChild(panel);

        // Initialize table state for this id
        tableState[id] = {
          headers: [],
          rowsOriginal: [],
          sort: { key: "Place", dir: "asc" },
        };
      }

      // ---- Table rendering (unchanged logic, now dynamic key) ----

      function renderTable(headers, data, headerId, bodyId, tableKey) {
        const theadTr = document.getElementById(headerId);
        const tbody = document.getElementById(bodyId);

        if (!theadTr || !tbody) return;

        theadTr.innerHTML = "";
        tbody.innerHTML = "";

        const currentSort = tableState[tableKey]?.sort || {
          key: "",
          dir: "asc",
        };

        headers.forEach((h) => {
          const th = document.createElement("th");
          th.className = [
            getColumnWidthClass(h),
            "px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 select-none",
            "cursor-pointer",
            "hover:text-gray-800",
            "sticky top-0 bg-gray-50 z-10 group",
          ].join(" ");
          th.setAttribute("data-key", h);
          th.setAttribute("role", "columnheader");

          const wrap = document.createElement("div");
          wrap.className = "flex items-center gap-1";
          const label = document.createElement("span");
          label.textContent = h;
          wrap.appendChild(label);

          const isSorted = currentSort.key === h;
          const iconSpan = document.createElement("span");
          iconSpan.className = isSorted
            ? "ml-1 mt-1 text-gray-500 opacity-100"
            : "ml-1 mt-1 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity";

          iconSpan.setHTMLUnsafe(
            isSorted
              ? currentSort.dir === "asc"
                ? `<svg xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
                    class="size-4">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v12m0 0-3.75-3.75M17.25 21 21 17.25" />
                  </svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
                    class="size-4">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25-.75L17.25 9m0 0L21 12.75M17.25 9v12" />
                  </svg>`
              : `<svg xmlns="http://www.w3.org/2000/svg" fill="none"
                  viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
                  class="size-4">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25-.75L17.25 9m0 0L21 12.75M17.25 9v12" />
                </svg>`
          );

          wrap.appendChild(iconSpan);
          th.appendChild(wrap);
          theadTr.appendChild(th);

          th.addEventListener("click", () => {
            const prev = tableState[tableKey].sort;
            const nextDir =
              prev.key === h && prev.dir === "asc" ? "desc" : "asc";
            tableState[tableKey].sort = { key: h, dir: nextDir };
            const sorted = sortRows(
              tableState[tableKey].rowsOriginal,
              h,
              nextDir
            );
            renderTable(headers, sorted, headerId, bodyId, tableKey);
            applySearch();
          });
        });

        data.forEach((row) => {
          const tr = document.createElement("tr");
          tr.className = "";
          headers.forEach((h) => {
            const td = document.createElement("td");
            const v = row[h] ?? row[h?.trim?.()] ?? "";
            const isNumeric =
              (typeof v === "number" && !isNaN(v)) ||
              (typeof v === "string" &&
                v.trim() !== "" &&
                !isNaN(Number(v.replaceAll(",", ""))));
            const hintNumeric = isLikelyNumericHeader(h);
            td.className =
              getColumnWidthClass(h) +
              " px-4 py-2 text-sm whitespace-nowrap " +
              (isNumeric || hintNumeric
                ? "text-right tabular-nums"
                : "text-gray-900");
            td.textContent = v;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        if (tbody.children.length === 0) {
          const noRow = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = headers.length || 1;
          td.className = "text-center py-4 text-gray-500";
          td.textContent = "No results found for your search.";
          noRow.appendChild(td);
          tbody.appendChild(noRow);
        }
      }

      // ---- CSV loading ----

      function loadCSV(file, headerId, bodyId) {
        const tableKey = headerId.replace(/Header$/, "");
        Papa.parse(file, {
          download: true,
          header: true,
          delimiter: "\t",
          skipEmptyLines: true,
          complete: (results) => {
            const raw = results.data || [];
            const rows = normalizeRows(raw);
            if (!rows.length) {
              tableState[tableKey].headers = [];
              tableState[tableKey].rowsOriginal = [];
              renderTable([], [], headerId, bodyId, tableKey);
              return;
            }
            const headers = Object.keys(rows[0]);
            tableState[tableKey].headers = headers;
            tableState[tableKey].rowsOriginal = rows;

            const defaultKey = headers.includes("Place") ? "Place" : headers[0];
            tableState[tableKey].sort = { key: defaultKey, dir: "asc" };
            const sorted = sortRows(rows, defaultKey, "asc");

            renderTable(headers, sorted, headerId, bodyId, tableKey);
            applySearch();
          },
          error: () => {
            renderTable(
              ["Error"],
              [{ Error: "Failed to load data" }],
              headerId,
              bodyId,
              tableKey
            );
          },
        });
      }

      // ---- Search across active tab ----

      function applySearch() {
        const inputEl = document.getElementById("searchInput");
        if (!inputEl) return;

        const value = (inputEl.value || "").toLowerCase().trim();
        const activePanel = document.querySelector(".tab-panel:not(.hidden)");
        if (!activePanel) return;
        const tbody = activePanel.querySelector("tbody");
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll("tr")).filter(
          (tr) => !tr.classList.contains("no-results-message")
        );

        let visibleCount = 0;
        rows.forEach((tr) => {
          const text = tr.textContent.toLowerCase();
          const isVisible = text.includes(value);
          tr.style.display = isVisible ? "" : "none";
          if (isVisible) visibleCount++;
        });

        // Remove any existing "no results" message
        const prevNoResults = tbody.querySelector(".no-results-message");
        if (prevNoResults) prevNoResults.remove();

        if (visibleCount === 0 && rows.length > 0) {
          let colCount =
            tbody.closest("table")?.querySelectorAll("thead tr th").length || 1;
          const noRow = document.createElement("tr");
          noRow.className = "no-results-message";
          const td = document.createElement("td");
          td.colSpan = colCount;
          td.className = "text-center py-4 text-gray-500";
          td.textContent = "No results found for your search.";
          noRow.appendChild(td);
          tbody.appendChild(noRow);
        }
      }

      // ---- Sort reset on tab change ----

      function resetSortOnTabChange(targetKey) {
        const st = tableState[targetKey];
        if (!st || !st.headers.length || !st.rowsOriginal.length) return;
        const defaultKey = st.headers.includes("Place")
          ? "Place"
          : st.headers[0];
        st.sort = { key: defaultKey, dir: "asc" };
        const sorted = sortRows(st.rowsOriginal, defaultKey, "asc");
        renderTable(
          st.headers,
          sorted,
          targetKey + "Header",
          targetKey + "Body",
          targetKey
        );
        applySearch();
      }

      // ---- Tab setup (after dynamic creation) ----

      function setupTabs() {
        const buttons = document.querySelectorAll(".tab-btn");
        const panels = document.querySelectorAll(".tab-panel");

        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const target = btn.getAttribute("data-tab-target");

            buttons.forEach((b) => {
              b.setAttribute("aria-selected", "false");
              b.classList.remove("text-blue-600", "border-blue-600");
              b.classList.add("text-gray-500", "border-transparent");
            });

            panels.forEach((p) => p.classList.add("hidden"));

            btn.setAttribute("aria-selected", "true");
            btn.classList.remove("text-gray-500", "border-transparent");
            btn.classList.add("text-blue-600", "border-blue-600");

            const panel = document.getElementById(target);
            if (panel) panel.classList.remove("hidden");

            resetSortOnTabChange(target);
            applySearch();
          });
        });
      }

      // ---- Search wiring ----

      function setupSearch() {
        const input = document.getElementById("searchInput");
        const clearBtn = document.getElementById("clearSearchBtn");
        if (!input || !clearBtn) return;

        function toggleClearBtn() {
          clearBtn.style.display = input.value ? "" : "none";
        }
        input.addEventListener("input", () => {
          applySearch();
          toggleClearBtn();
        });
        clearBtn.addEventListener("click", () => {
          input.value = "";
          applySearch();
          toggleClearBtn();
          input.focus();
        });
        toggleClearBtn();
      }

      // ---- Load meta.json & bootstrap everything ----

      async function loadEventMetaAndData() {
        try {
          const resp = await fetch(EVENT_BASE_PATH + "/meta.json");
          if (!resp.ok) throw new Error("Failed to load meta.json");
          const meta = await resp.json();

          // Header
          renderEventHeader(meta);

          // Tabs & panels
          const files = Array.isArray(meta.files) ? meta.files : [];
          if (!files.length) {
            const header = document.getElementById("eventHeader");
            const p = document.createElement("p");
            p.className = "mt-2 text-sm text-red-600";
            p.textContent = "No result files configured for this event.";
            header.appendChild(p);
            return;
          }

          files.forEach((fileObj, index) => {
            const id = slugify(fileObj.name || `tab-${index + 1}`);
            const label = fileObj.name || `Tab ${index + 1}`;
            const isActive = index === 0;
            createTabAndPanel(id, label, isActive);

            const csvPath = EVENT_BASE_PATH + "/" + fileObj.file;
            loadCSV(csvPath, id + "Header", id + "Body");
          });

          // After tabs and panels are in the DOM, wire interactions
          setupTabs();
          setupSearch();
        } catch (err) {
          const header = document.getElementById("eventHeader");
          header.innerHTML = "";
          const title = document.createElement("h1");
          title.className = "text-3xl font-bold text-red-700";
          title.textContent = "Unable to load event data";
          const msg = document.createElement("p");
          msg.className = "mt-1 text-gray-600 text-sm";
          msg.textContent = "Please check that the event metadata is available.";
          header.appendChild(title);
          header.appendChild(msg);
          // Still set up search so the UI doesn't break
          setupSearch();
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadEventMetaAndData();
      });
    </script>
  </body>
</html>
