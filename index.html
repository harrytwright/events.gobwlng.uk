<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tournament Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
      /* Custom scrollbar styling for webkit browsers */
      .overflow-x-auto::-webkit-scrollbar {
        height: 0.5rem;
      }
      .overflow-x-auto::-webkit-scrollbar-track {
        background: #f3f4f6;
        border-radius: 0.25rem;
      }
      .overflow-x-auto::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 0.25rem;
      }
      .overflow-x-auto::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }

      /* Smooth transitions for interactive elements */
      .tab-btn,
      button,
      th,
      tr {
        transition: all 150ms ease-in-out;
      }

      /* Loading skeleton animation */
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .skeleton {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      /* Print styles */
      @media print {
        body {
          background: white;
        }
        .tab-btn,
        #searchInput,
        #clearSearchBtn {
          display: none !important;
        }
        .tab-panel.hidden {
          display: block !important;
        }
        table {
          page-break-inside: auto;
        }
        tr {
          page-break-inside: avoid;
          page-break-after: auto;
        }
        thead {
          display: table-header-group;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
      <!-- Dynamic event header -->
      <header id="eventHeader" class="mb-8 text-center">
        <h1 class="text-1xl md:text-2xl lg:text-3xl font-bold text-gray-900">Loading event…</h1>
        <p class="mt-2 text-base text-gray-600">Please wait while we fetch the results.</p>
      </header>

      <section class="bg-white shadow-md border border-gray-200 rounded-lg">
        <div class="px-4 sm:px-6 pt-6">
          <div class="border-b border-gray-200">
            <nav
              id="tabsNav"
              class="-mb-px flex gap-4"
              role="tablist"
              aria-label="Results tabs"
            >
              <!-- Tabs will be injected from meta.json -->
            </nav>
          </div>

          <div class="mt-6">
            <div class="relative w-full md:max-w-md">
              <input
                id="searchInput"
                type="text"
                placeholder="Search for a player or team..."
                class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-base md:text-sm placeholder:text-gray-500 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
              />
              <button
                id="clearSearchBtn"
                type="button"
                class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-md text-gray-400 hover:text-gray-600 hover:bg-gray-100 active:bg-gray-200 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-gray-400"
                style="display: none"
                aria-label="Clear search"
              >
                <!-- Heroicon - X Mark (Mini) -->
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div id="panelsContainer" class="px-4 sm:px-6 pb-6">
          <!-- Tab panels will be injected from meta.json -->
        </div>
      </section>
    </main>

    <script>
      // ---- Utility: safe innerHTML for trusted SVG strings ----
      // Minimal helper to mirror the previous setHTMLUnsafe usage
      if (!Element.prototype.setHTMLUnsafe) {
        Element.prototype.setHTMLUnsafe = function (html) {
          this.innerHTML = html;
        };
      }

      // ---- Event configuration ----
      // Base path for this event; when you add more events,
      // this can be parameterised (e.g. via query string or build step).
      const EVENT_BASE_PATH = "./data/events/new-years-doubles/2026";

      // Format display name mappings
      const formatDisplayNames = {
        "doubles-reentry": "Re-Entry Doubles",
        "doubles-standard": "Standard Doubles",
        "fives-combination": "Combination 5's",
        "fives-diamond": "Diamond 5's",
        "fives-standard": "Standard 5's",
        "trios-reentry": "Re-Entry Trios",
        "singles-standard": "Singles",
        "scotch-doubles": "Scotch Doubles",
      };

      // Type display name mappings
      const typeDisplayNames = {
        "handicap": "Handicap",
        "scratch": "Scratch",
        "mixed": "Mixed",
      };

      // Preset widths per column key
      const columnWidthMap = {
        Place: "w-14 min-w-[3.5rem]",
        Squad: "w-12 min-w-[3rem]",
        Team: "w-28 min-w-[6rem]",
        Player: "w-32 min-w-[8rem]",
        "Player 1": "w-32 min-w-[8rem]",
        "Player 2": "w-32 min-w-[8rem]",
        HCP: "w-14 min-w-[3.5rem]",
        Scratch: "w-20 min-w-[5rem]",
        "Scratch Series": "w-24",
        "HCP Series": "w-24",
        "Game 1": "w-16",
        "Game 2": "w-16",
        "Game 3": "w-16",
        Pace: "w-14",
        Average: "w-20 min-w-[5rem]",
        // fallback default for unknown columns:
        "*": "min-w-[7rem]",
      };

      // Table state with headers, original rows, and last sort state
      // This is now dynamic; keys are slugified tab ids (from meta.files[].name)
      const tableState = {};

      const numericHeaderHints = [
        "place",
        "game",
        "series",
        "hcp",
        "average",
        "pace",
        "scratch",
      ];

      function normalizeRows(rows) {
        return rows.map((row) => {
          const out = {};
          Object.keys(row).forEach((k) => {
            const key = (k || "").trim();
            out[key] = row[k];
          });
          return out;
        });
      }

      function isLikelyNumericHeader(h) {
        return numericHeaderHints.some((k) => h.toLowerCase().includes(k));
      }

      function parseMaybeNumber(v) {
        if (typeof v === "number") return v;
        if (typeof v !== "string") return NaN;
        const s = v.replace(/,/g, "").trim();
        if (s === "") return NaN;
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
      }

      function sortRows(rows, key, dir) {
        const withIndex = rows.map((r, i) => ({ r, i }));
        const numericPreferred = isLikelyNumericHeader(key);
        withIndex.sort((a, b) => {
          const av = a.r[key] ?? a.r[key?.trim?.()];
          const bv = b.r[key] ?? b.r[key?.trim?.()];
          if (numericPreferred) {
            const an = parseMaybeNumber(av);
            const bn = parseMaybeNumber(bv);
            if (!Number.isNaN(an) && !Number.isNaN(bn)) {
              return dir === "asc" ? an - bn : bn - an;
            }
          }
          // Fallback string compare
          const as = (av ?? "").toString().toLowerCase();
          const bs = (bv ?? "").toString().toLowerCase();
          if (as < bs) return dir === "asc" ? -1 : 1;
          if (as > bs) return dir === "asc" ? 1 : -1;
          // stable
          return a.i - b.i;
        });
        return withIndex.map((x) => x.r);
      }

      function getColumnWidthClass(h) {
        return columnWidthMap[h] || columnWidthMap["*"];
      }

      // ---- Rendering: event header from meta.json ----

      function formatDateRange(dates) {
        if (!Array.isArray(dates) || dates.length === 0) return "";
        // Expecting dd/mm/yyyy or similar; we keep it simple and just join.
        if (dates.length === 1) return dates[0];
        if (dates.length === 2) return dates[0] + " – " + dates[1];
        return dates.join(", ");
      }

      function getDisplayName(value, mappings, defaultValue = "Unknown") {
        if (!value) return defaultValue;
        return mappings[value] || defaultValue;
      }

      function renderEventHeader(meta) {
        const header = document.getElementById("eventHeader");
        header.innerHTML = "";

        const title = document.createElement("h1");
        title.className = "text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 mb-4";
        title.textContent = meta.name || "Tournament Results";
        header.appendChild(title);

        const infoRow = document.createElement("div");
        infoRow.className = "flex flex-col md:flex-row flex-wrap items-center justify-center gap-3";

        // Format badge
        if (meta.format) {
          const formatBadge = document.createElement("span");
          formatBadge.className =
            "inline-flex items-center gap-1.5 text-sm font-semibold text-blue-700 bg-blue-100 border border-blue-200 rounded-lg px-3 py-1.5 shadow-sm";
          formatBadge.innerHTML = `
           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
</svg>

            <span>${getDisplayName(meta.format, formatDisplayNames)}</span>
          `;
          infoRow.appendChild(formatBadge);
        }

        // Type badge
        if (meta.type) {
          const typeBadge = document.createElement("span");
          typeBadge.className =
            "inline-flex items-center gap-1.5 text-sm font-semibold text-emerald-700 bg-emerald-100 border border-emerald-200 rounded-lg px-3 py-1.5 shadow-sm";
          typeBadge.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
  <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z" />
  <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6Z" />
</svg>

            <span>${getDisplayName(meta.type, typeDisplayNames)}</span>
          `;
          infoRow.appendChild(typeBadge);
        }

        // Pattern badge
        if (meta.pattern) {
          const patternBadge = document.createElement("span");
          patternBadge.className =
            "inline-flex items-center gap-1.5 text-sm font-semibold text-purple-700 bg-purple-100 border border-purple-200 rounded-lg px-3 py-1.5 shadow-sm";
          patternBadge.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
  <path stroke-linecap="round" stroke-linejoin="round" d="M4.098 19.902a3.75 3.75 0 0 0 5.304 0l6.401-6.402M6.75 21A3.75 3.75 0 0 1 3 17.25V4.125C3 3.504 3.504 3 4.125 3h5.25c.621 0 1.125.504 1.125 1.125v4.072M6.75 21a3.75 3.75 0 0 0 3.75-3.75V8.197M6.75 21h13.125c.621 0 1.125-.504 1.125-1.125v-5.25c0-.621-.504-1.125-1.125-1.125h-4.072M10.5 8.197l2.88-2.88c.438-.439 1.15-.439 1.59 0l3.712 3.713c.44.44.44 1.152 0 1.59l-2.879 2.88M6.75 17.25h.008v.008H6.75v-.008Z" />
</svg>

            <span>${meta.pattern}</span>
          `;
          infoRow.appendChild(patternBadge);
        }

        if (infoRow.children.length) header.appendChild(infoRow);

        // Dates - separate row for more prominence
        if (meta.dates && meta.dates.length) {
          const dateRow = document.createElement("div");
          dateRow.className = "mt-3 flex items-center justify-center gap-2 text-base text-gray-600";
          dateRow.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5  text-gray-600">
  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z" />
</svg>

            <span class="font-medium">${formatDateRange(meta.dates)}</span>
          `;
          header.appendChild(dateRow);
        }
      }

      // ---- Tabs & panels from meta.json ----

      function slugify(str) {
        return (str || "")
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^[-]+|[-]+$/g, "");
      }

      function createTabAndPanel(id, label, isActive) {
        const tabsNav = document.getElementById("tabsNav");
        const panelsContainer = document.getElementById("panelsContainer");

        // Tab button
        const btn = document.createElement("button");
        btn.className =
          "tab-btn whitespace-nowrap border-b-2 px-3 md:px-4 py-2 text-sm font-medium transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 rounded-t-md " +
          (isActive
            ? "text-blue-600 border-blue-600 hover:text-blue-600 hover:border-blue-600"
            : "text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent");
        btn.setAttribute("data-tab-target", id);
        btn.setAttribute("aria-selected", isActive ? "true" : "false");
        btn.setAttribute("role", "tab");
        btn.textContent = label;
        tabsNav.appendChild(btn);

        // Panel
        const panel = document.createElement("div");
        panel.id = id;
        panel.className =
          "tab-panel mt-6" + (isActive ? "" : " hidden");
        panel.setAttribute("role", "tabpanel");
        panel.setAttribute("aria-labelledby", id + "-tab");

        const wrapper = document.createElement("div");
        wrapper.className = "overflow-x-auto";

        const table = document.createElement("table");
        table.className = "min-w-full divide-y divide-gray-200";

        const thead = document.createElement("thead");
        thead.className = "bg-gray-50 sticky top-0 z-10";
        const trHead = document.createElement("tr");
        trHead.id = id + "Header";
        thead.appendChild(trHead);

        const tbody = document.createElement("tbody");
        tbody.id = id + "Body";
        tbody.className = "divide-y divide-gray-200 bg-white";

        table.appendChild(thead);
        table.appendChild(tbody);
        wrapper.appendChild(table);
        panel.appendChild(wrapper);
        panelsContainer.appendChild(panel);

        // Initialize table state for this id
        tableState[id] = {
          headers: [],
          rowsOriginal: [],
          sort: { key: "Place", dir: "asc" },
        };
      }

      // ---- Table rendering (unchanged logic, now dynamic key) ----

      function renderTable(headers, data, headerId, bodyId, tableKey) {
        const theadTr = document.getElementById(headerId);
        const tbody = document.getElementById(bodyId);

        if (!theadTr || !tbody) return;

        theadTr.innerHTML = "";
        tbody.innerHTML = "";

        const currentSort = tableState[tableKey]?.sort || {
          key: "",
          dir: "asc",
        };

        headers.forEach((h) => {
          const th = document.createElement("th");
          const isSorted = currentSort.key === h;
          th.className = [
            getColumnWidthClass(h),
            "px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider select-none",
            "cursor-pointer",
            "sticky top-0 z-10 group",
            isSorted ? "bg-blue-50 text-blue-700" : "bg-gray-50 text-gray-700 hover:bg-gray-100 hover:text-gray-900",
            "transition-colors",
          ].join(" ");
          th.setAttribute("data-key", h);
          th.setAttribute("role", "columnheader");

          const wrap = document.createElement("div");
          wrap.className = "flex items-center gap-1";
          const label = document.createElement("span");
          label.textContent = h;
          wrap.appendChild(label);

          const iconSpan = document.createElement("span");
          iconSpan.className = isSorted
            ? "ml-1 text-current opacity-100"
            : "ml-1 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity";

          iconSpan.setHTMLUnsafe(
            isSorted
              ? currentSort.dir === "asc"
                ? `<svg xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
                    class="size-4">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v12m0 0-3.75-3.75M17.25 21 21 17.25" />
                  </svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
                    class="size-4">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25-.75L17.25 9m0 0L21 12.75M17.25 9v12" />
                  </svg>`
              : `<svg xmlns="http://www.w3.org/2000/svg" fill="none"
                  viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
                  class="size-4">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25-.75L17.25 9m0 0L21 12.75M17.25 9v12" />
                </svg>`
          );

          wrap.appendChild(iconSpan);
          th.appendChild(wrap);
          theadTr.appendChild(th);

          th.addEventListener("click", () => {
            const prev = tableState[tableKey].sort;
            const nextDir =
              prev.key === h && prev.dir === "asc" ? "desc" : "asc";
            tableState[tableKey].sort = { key: h, dir: nextDir };
            const sorted = sortRows(
              tableState[tableKey].rowsOriginal,
              h,
              nextDir
            );
            renderTable(headers, sorted, headerId, bodyId, tableKey);
            applySearch();
          });
        });

        data.forEach((row, index) => {
          const tr = document.createElement("tr");
          tr.className = index % 2 === 0
            ? "bg-white hover:bg-blue-50 transition-colors"
            : "bg-gray-50 hover:bg-blue-50 transition-colors";
          headers.forEach((h) => {
            const td = document.createElement("td");
            const v = row[h] ?? row[h?.trim?.()] ?? "";
            const isNumeric =
              (typeof v === "number" && !isNaN(v)) ||
              (typeof v === "string" &&
                v.trim() !== "" &&
                !isNaN(Number(v.replaceAll(",", ""))));
            const hintNumeric = isLikelyNumericHeader(h);
            td.className =
              getColumnWidthClass(h) +
              " px-4 py-2 text-sm whitespace-nowrap " +
              (isNumeric || hintNumeric
                ? "text-right tabular-nums text-gray-900"
                : "text-gray-900");
            td.textContent = v;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        if (tbody.children.length === 0) {
          const noRow = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = headers.length || 1;
          td.className = "text-center py-8 text-gray-600 font-medium bg-gray-50";
          td.innerHTML = `
            <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
            <p>No results found for your search.</p>
          `;
          noRow.appendChild(td);
          tbody.appendChild(noRow);
        }
      }

      // ---- CSV loading ----

      function showLoadingSkeleton(bodyId, colCount = 5) {
        const tbody = document.getElementById(bodyId);
        if (!tbody) return;

        tbody.innerHTML = "";
        for (let i = 0; i < 5; i++) {
          const tr = document.createElement("tr");
          tr.className = "skeleton";
          for (let j = 0; j < colCount; j++) {
            const td = document.createElement("td");
            td.className = "px-4 py-2";
            const skeleton = document.createElement("div");
            skeleton.className = "h-4 bg-gray-200 rounded";
            td.appendChild(skeleton);
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
      }

      function loadCSV(file, headerId, bodyId) {
        const tableKey = headerId.replace(/Header$/, "");

        // Show loading skeleton
        showLoadingSkeleton(bodyId);

        Papa.parse(file, {
          download: true,
          header: true,
          delimiter: "\t",
          skipEmptyLines: true,
          complete: (results) => {
            const raw = results.data || [];
            const rows = normalizeRows(raw);
            if (!rows.length) {
              tableState[tableKey].headers = [];
              tableState[tableKey].rowsOriginal = [];
              renderTable([], [], headerId, bodyId, tableKey);
              return;
            }
            const headers = Object.keys(rows[0]);
            tableState[tableKey].headers = headers;
            tableState[tableKey].rowsOriginal = rows;

            const defaultKey = headers.includes("Place") ? "Place" : headers[0];
            tableState[tableKey].sort = { key: defaultKey, dir: "asc" };
            const sorted = sortRows(rows, defaultKey, "asc");

            renderTable(headers, sorted, headerId, bodyId, tableKey);
            applySearch();
          },
          error: () => {
            const tbody = document.getElementById(bodyId);
            if (tbody) {
              tbody.innerHTML = "";
              const tr = document.createElement("tr");
              const td = document.createElement("td");
              td.colSpan = 10;
              td.className = "text-center py-8 text-red-700 font-medium bg-red-50";
              td.innerHTML = `
                <svg class="w-12 h-12 mx-auto mb-3 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
                <p>Failed to load data</p>
                <p class="text-sm text-red-600 mt-1">Please check your connection and try again.</p>
              `;
              tr.appendChild(td);
              tbody.appendChild(tr);
            }
          },
        });
      }

      // ---- Search across active tab ----

      function applySearch() {
        const inputEl = document.getElementById("searchInput");
        if (!inputEl) return;

        const value = (inputEl.value || "").toLowerCase().trim();
        const activePanel = document.querySelector(".tab-panel:not(.hidden)");
        if (!activePanel) return;
        const tbody = activePanel.querySelector("tbody");
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll("tr")).filter(
          (tr) => !tr.classList.contains("no-results-message")
        );

        let visibleCount = 0;
        rows.forEach((tr) => {
          const text = tr.textContent.toLowerCase();
          const isVisible = text.includes(value);
          tr.style.display = isVisible ? "" : "none";
          if (isVisible) visibleCount++;
        });

        // Remove any existing "no results" message
        const prevNoResults = tbody.querySelector(".no-results-message");
        if (prevNoResults) prevNoResults.remove();

        if (visibleCount === 0 && rows.length > 0) {
          let colCount =
            tbody.closest("table")?.querySelectorAll("thead tr th").length || 1;
          const noRow = document.createElement("tr");
          noRow.className = "no-results-message";
          const td = document.createElement("td");
          td.colSpan = colCount;
          td.className = "text-center py-8 text-gray-600 font-medium bg-gray-50";
          td.innerHTML = `
            <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
            <p>No results found for your search.</p>
          `;
          noRow.appendChild(td);
          tbody.appendChild(noRow);
        }
      }

      // ---- Sort reset on tab change ----

      function resetSortOnTabChange(targetKey) {
        const st = tableState[targetKey];
        if (!st || !st.headers.length || !st.rowsOriginal.length) return;
        const defaultKey = st.headers.includes("Place")
          ? "Place"
          : st.headers[0];
        st.sort = { key: defaultKey, dir: "asc" };
        const sorted = sortRows(st.rowsOriginal, defaultKey, "asc");
        renderTable(
          st.headers,
          sorted,
          targetKey + "Header",
          targetKey + "Body",
          targetKey
        );
        applySearch();
      }

      // ---- Tab setup (after dynamic creation) ----

      function setupTabs() {
        const buttons = document.querySelectorAll(".tab-btn");
        const panels = document.querySelectorAll(".tab-panel");

        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const target = btn.getAttribute("data-tab-target");

            buttons.forEach((b) => {
              b.setAttribute("aria-selected", "false");
              b.classList.remove("text-blue-600", "border-blue-600", "hover:text-blue-600", "hover:border-blue-600");
              b.classList.add("text-gray-500", "border-transparent", "hover:text-gray-700", "hover:border-gray-300");
            });

            panels.forEach((p) => p.classList.add("hidden"));

            btn.setAttribute("aria-selected", "true");
            btn.classList.remove("text-gray-500", "border-transparent", "hover:text-gray-700", "hover:border-gray-300");
            btn.classList.add("text-blue-600", "border-blue-600", "hover:text-blue-600", "hover:border-blue-600");

            const panel = document.getElementById(target);
            if (panel) panel.classList.remove("hidden");

            resetSortOnTabChange(target);
            applySearch();
          });
        });
      }

      // ---- Search wiring ----

      function setupSearch() {
        const input = document.getElementById("searchInput");
        const clearBtn = document.getElementById("clearSearchBtn");
        if (!input || !clearBtn) return;

        function toggleClearBtn() {
          clearBtn.style.display = input.value ? "" : "none";
        }
        input.addEventListener("input", () => {
          applySearch();
          toggleClearBtn();
        });
        clearBtn.addEventListener("click", () => {
          input.value = "";
          applySearch();
          toggleClearBtn();
          input.focus();
        });
        toggleClearBtn();
      }

      // ---- Load meta.json & bootstrap everything ----

      async function loadEventMetaAndData() {
        try {
          const resp = await fetch(EVENT_BASE_PATH + "/meta.json");
          if (!resp.ok) throw new Error("Failed to load meta.json");
          const meta = await resp.json();

          // Header
          renderEventHeader(meta);

          // Tabs & panels
          const files = Array.isArray(meta.files) ? meta.files : [];
          if (!files.length) {
            const header = document.getElementById("eventHeader");
            const warning = document.createElement("div");
            warning.className = "mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-md";
            warning.innerHTML = `
              <svg class="w-8 h-8 mx-auto mb-2 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
              </svg>
              <p class="text-sm text-yellow-800 font-medium">No result files configured for this event.</p>
            `;
            header.appendChild(warning);
            return;
          }

          files.forEach((fileObj, index) => {
            const id = slugify(fileObj.name || `tab-${index + 1}`);
            const label = fileObj.name || `Tab ${index + 1}`;
            const isActive = index === 0;
            createTabAndPanel(id, label, isActive);

            const csvPath = EVENT_BASE_PATH + "/" + fileObj.file;
            loadCSV(csvPath, id + "Header", id + "Body");
          });

          // After tabs and panels are in the DOM, wire interactions
          setupTabs();
          setupSearch();
        } catch (err) {
          const header = document.getElementById("eventHeader");
          header.innerHTML = "";
          header.className = "mb-8 text-center p-8 bg-red-50 border border-red-200 rounded-lg";

          const icon = document.createElement("div");
          icon.innerHTML = `
            <svg class="w-16 h-16 mx-auto mb-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
            </svg>
          `;
          header.appendChild(icon);

          const title = document.createElement("h1");
          title.className = "text-2xl md:text-3xl font-bold text-red-700 mb-2";
          title.textContent = "Unable to load event data";

          const msg = document.createElement("p");
          msg.className = "text-base text-red-600";
          msg.textContent = "Please check that the event metadata is available and try again.";

          header.appendChild(title);
          header.appendChild(msg);
          // Still set up search so the UI doesn't break
          setupSearch();
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadEventMetaAndData();
      });
    </script>
  </body>
</html>
